#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running pre-commit quality gates..."

# üé® Code Formatting
echo "üé® Formatting code..."

# Check if any files need formatting
if ! npm run format:all:check; then
    echo "  ‚ö†Ô∏è  Code needs formatting, applying fixes..."
    npm run format:all
    echo "  ‚úÖ Code formatted successfully"
    
    # Re-add formatted files to staging area
    git add .
else
    echo "  ‚úÖ All code is properly formatted"
fi

# Run standard pre-commit checks (linting, type checking)
echo "üîç Running linting and type checks..."
npm run pre-commit

# Frontend-only mode (skips all backend-related checks)
if [ "$FRONTEND_ONLY" = "1" ]; then
    echo "‚ö†Ô∏è  Frontend-only mode enabled"
    echo "   Skipping all backend and integration tests"
    echo "‚úÖ Pre-commit quality gates passed!"
    exit 0
fi

# TDD workflow enforcement
echo "üîç Checking TDD compliance..."

# Check if TDD check should be skipped
if [ "$SKIP_TDD_CHECK" = "1" ]; then
    echo "‚ö†Ô∏è  TDD check skipped (SKIP_TDD_CHECK=1)"
    echo "   Please add unit tests in follow-up commits"
else
    # Check if any service files were modified
    MODIFIED_SERVICE_FILES=$(git diff --cached --name-only | grep "src-tauri/src/pawn/service/.*\.rs" | grep -v "mod.rs" | grep -v "tests/" || true)

    if [ -n "$MODIFIED_SERVICE_FILES" ]; then
        echo "üìù Modified service files detected:"
        echo "$MODIFIED_SERVICE_FILES"
        
        # Check that modified service files have tests
        for file in $MODIFIED_SERVICE_FILES; do
            if ! grep -q "#\[cfg(test)\]" "$file"; then
                echo "‚ùå TDD violation: $file has no tests"
                echo "   Please add unit tests before committing"
                echo "   TDD workflow: Red ‚Üí Green ‚Üí Refactor"
                exit 1
            else
                echo "‚úÖ $file has tests"
            fi
        done
    fi
fi

# Check if any new commands were added
NEW_COMMANDS=$(git diff --cached --name-only | grep "src-tauri/src/pawn/command/.*\.rs" | grep -v "mod.rs" || true)

if [ -n "$NEW_COMMANDS" ]; then
    echo "üì° Command files detected:"
    echo "$NEW_COMMANDS"
    
    # Check that permissions directory exists and has relevant permission files
    if [ ! -d "src-tauri/permissions/pawn" ]; then
        echo "‚ùå No permissions directory found: src-tauri/permissions/pawn"
        echo "   Please create permission files before committing"
        echo "   See CLAUDE.md for permission configuration"
        exit 1
    fi
    
    # Count permission files - if we have modified commands, we should have permissions
    PERMISSION_COUNT=$(find src-tauri/permissions/pawn -name "*.toml" -type f | wc -l)
    
    if [ "$PERMISSION_COUNT" -lt 10 ]; then
        echo "‚ùå Too few permission files found ($PERMISSION_COUNT)"
        echo "   Please ensure all commands have proper permissions"
        echo "   See CLAUDE.md for permission configuration"
        exit 1
    else
        echo "‚úÖ Permission files found ($PERMISSION_COUNT permissions)"
    fi
fi

# Check that integration tests exist for new database operations
if [ "$SKIP_INTEGRATION_TESTS" != "1" ]; then
    DB_CHANGES=$(git diff --cached --name-only | grep "src-tauri/src/pawn/db/.*\.rs" || true)

    if [ -n "$DB_CHANGES" ]; then
        echo "üóÑÔ∏è Database changes detected:"
        echo "$DB_CHANGES"
        
        # Check that integration tests exist (either in tests/ directory or tests/integration/)
        if [ -d "src-tauri/tests" ] && [ -n "$(find src-tauri/tests -name '*.rs' -type f 2>/dev/null)" ]; then
            echo "‚úÖ Integration tests found"
        else
            echo "‚ùå No integration tests found"
            echo "   Please add integration tests for database changes"
            exit 1
        fi
    fi
elif [ "$SKIP_INTEGRATION_TESTS" = "1" ]; then
    echo "‚ö†Ô∏è  Integration tests skipped (SKIP_INTEGRATION_TESTS=1)"
fi

# Check test coverage (if tarpaulin is available)
if [ "$SKIP_BACKEND_TESTS" != "1" ] && command -v cargo-tarpaulin >/dev/null 2>&1; then
    echo "üìä Checking test coverage..."
    
    cd src-tauri
    
    # Run coverage check with timeout
    timeout 60s cargo tarpaulin --ignore-panics --exclude-files "src/main.rs" --print-summary || {
        echo "‚ö†Ô∏è  Coverage check timed out or failed"
        echo "   Continuing with commit (coverage will be checked in CI)"
    }
    
    cd ..
elif [ "$SKIP_BACKEND_TESTS" = "1" ]; then
    echo "‚ö†Ô∏è  Backend tests skipped (SKIP_BACKEND_TESTS=1)"
fi

echo "‚úÖ Pre-commit quality gates passed!"